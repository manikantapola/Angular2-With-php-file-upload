import {
  Directive,
  ElementRef,
  EventEmitter,
  Input,
  Output,
  HostListener,
  Inject,
  OnChanges
} from '@angular/core';
import { Ng2UploaderService } from '../services/ng2-uploader';
import { INg2UploaderOptions, Ng2UploaderOptions, UploadedFile, UploadRejected } from '../classes';

@Directive({
  selector: '[ngFileSelect]'
})
export class NgFileSelectDirective implements OnChanges {
  @Input() options: Ng2UploaderOptions;
  @Input() events: EventEmitter<any>;
  @Output() onUpload: EventEmitter<any> = new EventEmitter();
  @Output() onPreviewData: EventEmitter<any> = new EventEmitter();
  @Output() onUploadRejected: EventEmitter<UploadRejected> = new EventEmitter<UploadRejected>();
  @Output() beforeUpload: EventEmitter<UploadedFile> = new EventEmitter<UploadedFile>();

  files: any[] = [];

  constructor(
    @Inject(ElementRef) public el: ElementRef,
    @Inject(Ng2UploaderService) public uploader: Ng2UploaderService) { }

  ngOnChanges() {
    if (!this.options) {
      return;
    }

    this.uploader.setOptions(new Ng2UploaderOptions(this.options));

    this.uploader._emitter.subscribe((data: any) => {
      this.onUpload.emit(data);
      if (data.done) {
        console.log(this.files);
        //this.files = this.files.filter(f => f.name !== data.originalName);
        //this.files = data;
      }
    });

    this.uploader._previewEmitter.subscribe((data: any) => {
      this.onPreviewData.emit(data);
    });

    this.uploader._beforeEmitter.subscribe((uploadingFile: UploadedFile) => {
      this.beforeUpload.emit(uploadingFile)
    });

    if (this.events instanceof EventEmitter) {
      this.events.subscribe((data: string) => {
        if (data === 'startUpload') {
          this.uploader.uploadFilesInQueue('');
        }
      });
    }
  }

  @HostListener('dblclick') onDblclick(): void {
    this.files = this.el.nativeElement.files;
    var message = '';
    if (!this.files) {
      return;
    }

    if (this.options.filterExtensions && this.options.allowedExtensions && this.files && this.files.length) {

      const file = this.files[0];
      console.log("CK "+this.options.allowedExtensions.indexOf(file.type))
      if (this.options.allowedExtensions.indexOf(file.type) === -1) {
        console.log("FT "+file.type);
        message = "Only json files are supported";
        //this.onUploadRejected.emit({file: file, reason: UploadRejected.EXTENSION_NOT_ALLOWED});
      }

      if(this.files.length > this.options.maxUploads){
        message = "please select less than "+this.options.maxUploads+"  files";
      }
    }

    if (this.files.length) {
      console.log("BEFORe" +message);
      this.uploader.addFilesToQueue(this.files, message);
    }
  }
}
